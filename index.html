import React, { useEffect, useRef, useState } from "react";
import Globe from "globe.gl";

// ✅ Pré-requis (à installer dans votre projet):
//   npm i globe.gl three
//   — Tailwind est optionnel (utilisé ici pour le style)

export default function GlobeGithubDemo() {
  const containerRef = useRef(null);
  const globeRef = useRef(null);
  const [loading, setLoading] = useState(true);
  const [showPolygons, setShowPolygons] = useState(true);
  const [showPoints, setShowPoints] = useState(true);
  const [showArcs, setShowArcs] = useState(true);

  // Petites villes de démo pour les arcs
  const demoCities = [
    { name: "Paris", lat: 48.8566, lng: 2.3522 },
    { name: "New York", lat: 40.7128, lng: -74.006 },
    { name: "Tokyo", lat: 35.6762, lng: 139.6503 },
    { name: "São Paulo", lat: -23.5505, lng: -46.6333 },
    { name: "Johannesburg", lat: -26.2041, lng: 28.0473 },
    { name: "Sydney", lat: -33.8688, lng: 151.2093 }
  ];

  // Génère quelques arcs entre les villes ci-dessus
  function buildDemoArcs() {
    const pairs = [
      [0, 1], // Paris -> New York
      [1, 2], // New York -> Tokyo
      [2, 5], // Tokyo -> Sydney
      [0, 3], // Paris -> São Paulo
      [4, 0]  // Johannesburg -> Paris
    ];
    return pairs.map(([i, j]) => ({
      startLat: demoCities[i].lat,
      startLng: demoCities[i].lng,
      endLat: demoCities[j].lat,
      endLng: demoCities[j].lng,
      name: `${demoCities[i].name} → ${demoCities[j].name}`,
      color: ["#22c55e", "#3b82f6", "#ef4444", "#a855f7", "#eab308"][i % 5]
    }));
  }

  useEffect(() => {
    if (!containerRef.current) return;

    // Initialisation du globe
    const globe = Globe()(containerRef.current)
      .backgroundColor("#0b1020")
      .globeImageUrl("https://unpkg.com/three-globe/example/img/earth-blue-marble.jpg")
      .bumpImageUrl("https://unpkg.com/three-globe/example/img/earth-topology.png")
      .showGraticules(true)
      .atmosphereColor("#aeeaff")
      .atmosphereAltitude(0.18)
      .pointOfView({ lat: 20, lng: 0, altitude: 2.2 });

    globeRef.current = globe;

    // Chargement de données publiques depuis GitHub (ou équivalent) pour l'exemple
    // 1) Polygones du monde (GeoJSON) – source: holtzy/D3-graph-gallery
    const worldGeoUrl =
      "https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson";

    // 2) Points de population – source: vasturiano/globe.gl (datasets d'exemple)
    const populationUrl =
      "https://raw.githubusercontent.com/vasturiano/globe.gl/master/example/datasets/population.json";

    (async () => {
      try {
        const [worldRes, popRes] = await Promise.all([
          fetch(worldGeoUrl),
          fetch(populationUrl)
        ]);
        const worldGeo = await worldRes.json();
        const population = await popRes.json();

        // Polygones (pays)
        globe
          .polygonsData(worldGeo.features)
          .polygonCapColor(() => "rgba(255,255,255,0.06)")
          .polygonSideColor(() => "rgba(200,200,200,0.15)")
          .polygonStrokeColor(() => "rgba(255,255,255,0.2)")
          .polygonAltitude(() => 0.01);

        // Points (population)
        globe
          .pointsData(population)
          .pointAltitude((d) => Math.max(0.01, d.pop * 0.00000008))
          .pointRadius(0.4)
          .pointLabel((d) => `${d.city}: ${d.pop.toLocaleString()}`)
          .pointColor(() => "#22c55e");

        // Arcs démo
        globe
          .arcsData(buildDemoArcs())
          .arcAltitude(({ startLat, endLat }) =>
            0.1 + Math.abs(startLat - endLat) / 180
          )
          .arcStroke(0.7)
          .arcDashLength(0.6)
          .arcDashGap(0.2)
          .arcDashInitialGap(() => Math.random())
          .arcDashAnimateTime(3000)
          .arcLabel((d) => d.name)
          .arcColor((d) => d.color);

        setLoading(false);
      } catch (e) {
        console.error("Erreur de chargement des données", e);
        setLoading(false);
      }
    })();

    // Resize handler
    const onResize = () => {
      const { clientWidth, clientHeight } = containerRef.current;
      globe.width(clientWidth);
      globe.height(clientHeight);
    };
    window.addEventListener("resize", onResize);
    onResize();

    return () => {
      window.removeEventListener("resize", onResize);
      // Nettoyage du canvas
      if (containerRef.current) {
        while (containerRef.current.firstChild) {
          containerRef.current.removeChild(containerRef.current.firstChild);
        }
      }
    };
  }, []);

  // Montre / cache dynamiquement les couches
  useEffect(() => {
    const globe = globeRef.current;
    if (!globe) return;
    globe.showPolygons(showPolygons);
    globe.showPoints(showPoints);
    globe.showArcs(showArcs);
  }, [showPolygons, showPoints, showArcs]);

  return (
    <div className="w-full h-screen bg-slate-900 text-slate-100">
      <div className="absolute z-10 m-4 p-4 rounded-2xl shadow-xl bg-slate-800/80 backdrop-blur grid gap-3">
        <h1 className="text-xl font-semibold">Globe.gl – Démo avec données GitHub</h1>
        <div className="flex items-center gap-4 text-sm">
          <label className="flex items-center gap-2">
            <input
              type="checkbox"
              checked={showPolygons}
              onChange={(e) => setShowPolygons(e.target.checked)}
            />
            Polygones (pays)
          </label>
          <label className="flex items-center gap-2">
            <input
              type="checkbox"
              checked={showPoints}
              onChange={(e) => setShowPoints(e.target.checked)}
            />
            Points (population)
          </label>
          <label className="flex items-center gap-2">
            <input
              type="checkbox"
              checked={showArcs}
              onChange={(e) => setShowArcs(e.target.checked)}
            />
            Arcs (routes démo)
          </label>
        </div>
        {loading && (
          <div className="text-xs opacity-80">Chargement des tuiles et des données…</div>
        )}
        <div className="text-xs opacity-70">
          Astuce: maintenez la souris pour pivoter, molette pour zoomer.
        </div>
      </div>

      <div ref={containerRef} className="w-full h-full" />
    </div>
  );
}
